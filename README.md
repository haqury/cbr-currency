# CBR Currency API

**API курсов ЦБ РФ: кэш (Redis), очередь (Redis), опциональное хранение в БД.**

---

## Описание

Проект — **только backend API** (без фронтенда). Загружает ежедневные курсы из XML API ЦБ РФ, кэширует ответы в Redis и может сохранять курсы в PostgreSQL. Очередь обрабатывает задачи синхронизации. Основной эндпоинт возвращает курс на дату, предыдущий торговый день и **дельту** (изменение к предыдущему дню).

---

## Требования

- **Docker** и **Docker Compose**

Скопируйте `.env.example` в `.env` и задайте минимум `APP_KEY` (и учётные данные БД при необходимости).

---

## Запуск через Docker

Запуск всех сервисов (app, nginx, postgres, redis, worker):

```bash
docker-compose up -d
```

API доступен по адресу **http://localhost:8080** (nginx проксирует на php-fpm).

---

## Миграции

Выполните миграции в контейнере приложения:

```bash
docker-compose exec app php artisan migrate
```

---

## Синхронизация истории курсов

Чтобы заполнить БД (и кэш) историческими курсами, выполните команду синхронизации. Она **ставит в очередь** задачи по дням; контейнер **worker** их обрабатывает.

Пример для USD за последние 180 дней:

```bash
docker-compose exec app php artisan app:sync-currency-history USD --days=180
```

Можно указать другой код валюты (например EUR) и изменить `--days`.

---

## API: GET /api/rates

**Пример запроса:**

```http
GET /api/rates?date=2025-02-20&currency_code=USD&base_currency_code=RUR
```

**Параметры запроса:**

| Параметр              | Обязательный | Описание                                           |
|-----------------------|--------------|----------------------------------------------------|
| `date`                | да           | Дата в формате `Y-m-d` (например 2025-02-20)       |
| `currency_code`       | да           | Код валюты (например USD, EUR)                     |
| `base_currency_code`  | нет          | Базовая валюта; по умолчанию `RUR` (поддерживается только RUR) |

**Пример ответа:**

```json
{
  "date": "2025-02-20",
  "currency_code": "USD",
  "base_currency_code": "RUR",
  "rate": 98.1234,
  "previous_trade_date": "2025-02-19",
  "delta": 0.5678
}
```

- **rate** — курс на запрошенную дату (из БД или ЦБ с кэшем).
- **previous_trade_date** — последняя дата до запрошенной, по которой есть курс (предыдущий торговый день).
- **delta** — разница между текущим курсом и курсом предыдущего торгового дня (`rate − previous_rate`).

Если курс на запрошенную дату не найден, API возвращает **404**. Проверка здоровья: **GET /up**.

---

## Проверка

Чтобы убедиться, что всё работает, используйте Docker (приложение рассчитано на PostgreSQL и Redis; запуск `php artisan serve` локально без них приведёт к ошибке).

1. **Запуск:** `docker-compose up -d`

2. **Миграции:** `docker-compose exec app php artisan migrate`

3. **Синхронизация данных (по желанию, но рекомендуется):**  
   `docker-compose exec app php artisan app:sync-currency-history USD --days=30`  
   Подождите 30–60 секунд, пока воркер обработает задачи.

4. **Проверка здоровья:** `curl http://localhost:8080/up` — в ответе должно быть `OK`.

5. **API курсов:**  
   `curl "http://localhost:8080/api/rates?date=2025-02-20&currency_code=USD&base_currency_code=RUR"`  
   Ожидается JSON с полями `rate`, `previous_trade_date`, `delta`.
